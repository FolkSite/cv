# Назначение

ПО состоит из 2-х скриптов:

1. Загрузка URL и конвертация веб-страницы в файлы формата DOM HTML и [Markdown](https://guides.github.com/features/mastering-markdown/).
2. Распознавание и извлечение именованных сущностей из неструктурированного текста (из файла Markdown).

Скрипты используются для загрузки (импортирования) резюме и вакансий из разных сайтов, их обработки и добавления на сайт `https://rabota.ru`.

# Требования к рабочему окружению

* ОС, совместимая с `Linux Ubuntu x64 v16.x` или более поздняя
* `1 GB` оперативной памяти
* `32 Mb` свободного места на диске
* `NodeJS v8.9.0` или более поздняя ([инструкция по установке](https://nodejs.org/en/download/package-manager/#debian-and-ubuntu-based-linux-distributions))

# Установка

```bash
$ git clone git@git.rabota.space:rdw/rabota-importer.git
$ cd rabota-importer
$ chmod +x ./install.sh && ./install.sh
```

# Структура папок проекта

Папка               | Описание
--------------------|---------------------------------------------------------------------------------------------------
`dev`               | Набор разных файлов, применяемых в разработке, для продуктивного окружения не используются
`dict`              | Словари, используемые для распознавания именованных сущностей
`lib`               | Библиотеки программного кода
`log`               | Папка для выгрузки обработанных файлов, место хранения кук
`node_modules`      | Модули для `NodeJS`
`phantomjs_modules` | Модули для `PhantomJS` 
`test`              | Набор тестовых экземпляров для тестирования распознавания сущностей
`tmp`               | Папка для кеша `PhantomJS` и временных файлов
`vendor`            | Сторонние библиотеки, которые используются в проекте
`vendor/bin`        | Сторонние исполняемые файлы, которые используются в проекте

# Использование скриптов

## Выгрузка веб-страницы в файл

**Формат вызова**

`$ ./import.sh <опции…> [2> <errorFile>]`
    
В квадратных скобках указана необязательная часть.

**Показать все опции**

`$ ./import.sh` или `$ cat import.txt` выводит в консоль терминала:

```
Назначение:
    Загрузка URL и конвертация веб-страницы в файлы формата DOM HTML и Markdown

Использование:
    $ ./import.sh <опции...>

Опции обязательные: 
    --config-file=<значение>        Файл конфигурации (config.*.js)
    --url=<значение>                URL для загрузки

Опции необязательные: 
    --output-file-prefix=<значение> Префикс файлов для записи на диск, по-умолчанию "page"
    --username=<значение>           Имя пользователя для авторизации на сайте через форму ввода
    --password=<значение>           Пароль пользователя для авторизации на сайте через форму ввода
    --http-user-agent=<значение>    HTTP заголовок "User-Agent", который нужно передать в браузер
    --verbose                       Выводить подробную/расширенную информацию
    --no-color                      Отключить покраску цветом сообщений, выводимых в терминал
    --color                         Включить покраску цветом сообщений, если вывод перенаправляется не в терминал

Документация:
    $ cat README.md
```

**Пример вызова**

`$ ./import.sh --config-file=config.resume.js --url="https://ya.ru" --output-file-prefix=ya`

**Особенности работы**

* Скрипт может загружать веб-страницы с поддержкой `JavaScript`, `AJAX`, `Cookie`, сеансов, перенаправлений и авторизации (вход по логину и паролю).
* Из ресурсов веб-страницы изображения, аудио, видео и шрифты по ссылкам (кроме [`data:URI`](https://en.wikipedia.org/wiki/Data_URI_scheme)) не загружаются (нет необходимости).
За счёт этого экономится трафик, увеличивается скорость работы, снижается количество запросов к серверам и нагрузка на них.
* Максимальное время выполнения скрипта — 35 секунд (настраивается в `import.sh`)
* Максимальное время ожидания загрузки ресурсов (`*.css`, `*.js`, `…`) — 20 секунд (настраивается в `import.js`)
* Скрипт имеет защиту от зацикливания по URL
* Для своей работы скрипт использует консольный браузер [PhantomJS](http://phantomjs.org/) (исполняемый файл `./vendor/bin/phantomjs`)

**На выходе записываются файлы**

Если сервер отвечает с типом содержимого `text/html`:

1. `./log/<output-file-pefix>.dom.html` — файл с DOM HTML, который сформировал браузер после загрузки страницы и выполнения javascript скриптов.
Можно настраивать элемент DOM для выгрузки в HTML через указание CSS селектора в конфигурационном файле, по умолчанию это `body`.
В блоке `<head>` в теге `<meta name="source" …>` хранится ссылка на источник выгрузки, дата и время выгрузки. HTML отфильтован и записывается: 
    * без скриптов (`<script>`)
    * без стилей (`<style>`)
    * без комментариев (`<!-- … -->`)
    * без скрытых/невидимых элементов (`display:none; visibility:hidden; opacity:0` и отступы элементов за пределы видимости экрана монитора)
    * без атрибутов с обработчиками событий (`on*`)
    * без атрибутов `style`
2. `./log/<output-file-pefix>.md` — файл в формате [Markdown](https://guides.github.com/features/mastering-markdown/).
При конвертации из DOM HTML в Markdown содержимое тегов `<iframe>` игнорируется.
Внизу файла дописывается ссылка на источник выгрузки, дата и время выгрузки. 
Текущая реализация конвертации из HTML в Markdown неполная, но поддерживает обработку основных HTML элементов: 
    * параграфы (`<p>`)
    * переносы строк (`<br/>`) 
    * заголовки (`<h1>`, … `<h6>`)
    * элементы списков (`<li>`) 
    * ссылки (`<a href="…" title="…">…</a>`)
    * изображения (`<img src="…" alt="…"/>`)

Если сервер отвечает с типом содержимого `application/json`:
* `./log/<output-file-pefix>.json` — файл в формате [JSON](http://www.json.org/). 
Файл сохраняется в форматированном виде с отступами, структура данных остаётся в неизменном виде.

Обязательные файлы для хранения кук (cookie):
1. `./log/<config-type>~[<username>]@cookies-persistent.txt` — для постоянных кук. 
Тип конфига `<config-type>` берётся из значения параметра `--config-file`, формат: `config.<config-type>.js`.
Имя пользователя `<username>` будет записано, если оно было передано через опцию `--username` командной строки.
2. `./log/<config-type>~[<username>]@<hostname>.cookies.json` — для сессионных кук. 

В случае возникновения ошибки файлы записаны не будут, а скрипт вернёт код возврата `1`. 

**Потоки**

1. В `STDOUT` пишутся:
    * `белым цветом`: сообщения PhantomJS о ходе работы скрипта (начало операции/шага, сводная информация, статистика)
    * `зелёным цветом`: сообщения об успешных операциях/шагах
    * `синим цветом`: 
        * сообщения о перенаправлениях на другой URL
        * данные POST запроса 
        * сообщения скриптов веб-страницы, выведенные в консоль браузера (методы `console.*()`)
    * `оранжевым цветом`: сообщения с предупреждениями — допустимые логикой скрипта ошибки (скрипт не прерывает работу)
2. В `STDERR` пишутся (`красным цветом`):
    * сообщения об ошибках выполнения PhantomJS (скрипт прерывает работу)
    * сообщения об ошибках выполнения скриптов веб-страницы (скрипт не прерывает работу) 

### Сценарий авторизации (шаги)

1. Загружаем страницу `startUrl` (его передали скрипту через параметр `--url`)
2. Если `startUrl` изменился (ответ сервера с кодом 301), то заменяем его на новый
3. Проверяем, авторизован ли пользователь на странице `startUrl` (по наличию формы авторизации или «магических» меток)
4. Если пользователь авторизован, сохраняем результат загрузки страницы `startUrl` и завершаем работу (успех)
5. Если не удалось определить, авторизован ли пользователь, то завершаем работу с ошибкой
6. Если на странице `startUrl` формы авторизации нет, загружаем страницу `authUrl`
7. Если на странице `authUrl` формы авторизации нет, завершаем работу с ошибкой авторизации
8. Заполняем форму авторизации (вводим имя пользователя и пароль, отмечаем флаг «запомнить», если он есть) и отправляем данные на сервер на `authPostUrl` (`<form action="authPostUrl">`)
9. Загружаем страницу `authPostUrl`
10. Проверяем, авторизован ли пользователь на странице `authPostUrl` (по наличию формы авторизации или «магических» меток)
11. Если не удалось определить, авторизован ли пользователь, то завершаем работу с ошибкой
12. Если пользователь авторизован, переходим к пункту `1`.
13. Завершаем работу с ошибкой авторизации (неверное имя пользователя и/или пароль?)

## Распознавание и извлечение информации

**Формат вызова**

`$ ./extract.sh <опции…> [2> <errorFile>]`

В квадратных скобках указана необязательная часть.

**Показать все опции**

`$ ./extract.sh` или `$ cat extract.txt` выводит в консоль терминала:

```
Назначение:
    Распознавание и извлечение именованных сущностей из неструктурированного текста (из файла Markdown)

Использование:
    $ ./extract.sh <опции...>

Опции обязательные:
    --config-file=<значение>   Файл конфигурации (config.*.js)
    --input-file=<значение>    Файл в формате Markdown (*.md)
    --extract-type=<значение>  Тип обработки, возможные значения:
                                 * links — из входящего файла собирается список ссылок на документы и другие списки,
                                   на выходе записывается файл ./log/<input-file-prefix>.links.json
                                 * document — из входящего файла извлекаются именованные сущности,
                                   на выходе записывается файл ./log/<input-file-prefix>.document.json
Опции необязательные:
    --save-tree     Сохранять всю распарсенную структуру данных в файл ./log/<input-file-prefix>.tree.json
                    (только для --extract-type=document)
    --verbose       Выводить подробную/расширенную информацию
    --debug         Режим отладки (записываются файлы ./log/<input-file-prefix>.<step-number>.<step-name>.<extension>
                    с данными для каждого этапа обработки)
    --no-color      Отключить покраску цветом сообщений, выводимых в терминал
    --color         Включить покраску цветом сообщений, если вывод перенаправляется не в терминал

Документация:
    $ cat README.md
```

**Особенности работы**

* Для определения морфологических признаков слов скрипт вызывает консольную программу [Mystem](https://tech.yandex.ru/mystem/doc/) (исполняемый файл `./vendor/bin/mystem`). 

**Потоки**

* В `STDOUT` пишется результат работы (JSON)
* В `STDERR` пишутся сообщения об ошибках

### Типы обработки данных

Существует 2 типа обработки текста в формате Markdown:

* **`links`** — собирается список ссылок на документы и другие списки, на выходе записывается JSON файл `./log/<input-file-prefix>.links.json`.
* **`document`** — извлекаются именованные сущности, на выходе записывается JSON файл `./log/<input-file-prefix>.document.json`. 
  Структура файла определяется распознанными сущностями и словарями, которые использовались для этого. 

В файле `./log/<input-file-prefix>.links.json` хранится JSON объект со следующими свойствами:

Свойство             | Тип                 | Обязательный? | Описание
---------------------|---------------------|---------------|---------------------------------------------------------
**source**           | `Object`            | да            | Источник исходной HTML страницы, выгруженной в Markdown
  source.text        | `String`            | да            |     Константа, = `"source"`
  source.url         | `String`            | да            |     URL ссылки
  source.title       | `String`            | да            |     Заголовок страницы из тега `<title>`
  source.hostAliases | `String`            | да            |     Регулярное выражение из параметра `<host>.hostAliases` конфигурационного файла 
**lists**            | `Array` of `Object` | да            | Список ссылок на списки документов из постраничной навигации.  
  lists[].text       | `String`            | да            |     Текст ссылки, обычно содержит номер страницы от постраничной навигации
  lists[].url        | `String`            | да            |     URL ссылки. Все ссылки соответствуют регулярному выражению параметра `<host>.lists.urlMatch` из конфигурационного файла.
**documents**        | `Array`of `Object`  | да            | Список ссылок на документы
  documents[].text   | `String`            | да            |     Текст ссылки 
  documents[].url    | `String`            | да            |     URL ссылки. Все ссылки соответствуют регулярному выражению параметра `<host>.document.urlMatch` из конфигурационного файла.
  documents[].id     | `String`            | да            |     Идентификатор документа из `documents[].url`. См. параметр `<host>.document.idBackref` из конфигурационного файла.

### Этапы обработки данных

1. Загружаем текст в формате Markdown из файловой системы
2. Загружаем словари из папки `dict`.
3. Конструируем грамматику (шаблоны регулярных выражений) для распознавания именованных сущностей. Для некоторых грамматик используются простые словари.
4. Исправлям ошибочно набранные буквы, которые выглядят одинаково в разной раскладке клавиатуры (поддерживаются русский и английский языки)
5. Если тип обработки — это извлечь ссылки, то делаем это, сохраняем результат в JSON и завершаем работу. Иначе:
6. Токенизируем текст 1-м набором регулярных выражений, заменяем токены на метки-заменители
7. Отделяем друг от друга «прилипшие» слова (например, `РостовНаДону` => `Ростов На Дону`) 
8. Токенизируем текст 2-м набором регулярных выражений, заменяем токены на метки-заменители
9. Лемматизируем текст через `Mystem` и получаем базовую форму слов с [грамматическими признаками](https://tech.yandex.ru/mystem/doc/grammemes-values-docpage/)
10. Заменяем метки-заменители обратно на их значения с разметкой токенов в тексте 
12. Извлекаем из текста токены в одномерный массив объектов токенов `tokensFlat`
13. Из одномерного массива объектов токенов строим многомерный массив (дерево) объектов токенов `tokensTree` следующей вложенной структуры: параграфы, предложения, токены вне ссылок, токены из текста/заголовков ссылок/изображений.
14. Обходим дерево токенов и извлекаем именованные сущности с помощью словарей и правил-эвристик
15. Сохраняем результат в JSON и завершаем работу 

### Группы именованных сущностей

 № | Название          | Описание | Примеры
---|-------------------|----------|-------------------------------------------------------------------------------------
 1 | Шаблонная         | Сущность можно описать шаблоном и идентифицировать [регулярным выражением](https://ru.wikipedia.org/wiki/Регулярные_выражения). | Телефон, email, url, число, валюта, дата, фамилия, отчество
 2 | Словарная простая | Сущность нельзя описать шаблоном. Идентификация происходит через поиск фразы в словаре.                 | Имя человека, город, метро
 3 | Словарная сложная | Идентификация происходит через поиск фразы в словаре и слов, находящихся слева и/или справа от фразы.   | Место работы, время в пути
 4 | Словарно-шаблонная| Сущность необходимо описать словарём и шаблоном одновременно    | Организацоннно правовая форма, после которой стоит название компании в кавычах-ёлочках (`«»`)
 5 | Вычисляемая       | Сущность вычисляется на основе других сущностей и словарей.     | Пол человека (вычисляется из ФИО)

### Типы именованных сущностей

Список типов (разновидностей) объеков токенов, которые могут встречаться в массиве `tokensTree`

#### Скаляры

  № | Тип сущности        | Тип данных | Формат распознанных данных                                               | Название сущности                 | Примеры исходного текста для распознавания                                                                  | Описание и особенности распознавания
---:|---------------------|------------|--------------------------------------------------------------------------|-----------------------------------|-------------------------------------------------------------------------------------------------------------|-------------------------------------
  1 | float               | `Number`   |                                                                          | Число с плавающей запятой         | `-74`, <nobr>`84.37`,</nobr> <nobr>`+1.5e-2`,</nobr> <nobr>`129 000`,</nobr> <nobr>`35,000`</nobr>          | Распознаются целые и дробные числа, положительные и отрицательные, с экспонентой и без ([тест](https://regex101.com/r/4qzaqL/2/)). Числа должны соответствовать формату [JSON Number](http://www.json.org/). Дополнительно группы по тысяче могут быть разделены запятой (`,`) или пробелом (` `).
  2 | paymentCard         | `Integer`  | [Payment card number](https://en.wikipedia.org/wiki/Payment_card_number) | Номер банковской карты            | `4556214349109`, `4539146807121309`, <nobr>`4539 1468 0712 1309`,</nobr> <nobr>`4539-1468-0712-1309`</nobr> | Влияет на корректность распознавания сущности `float`. При распознавании номер валидируется алгоритмом «[Луна](https://ru.wikipedia.org/wiki/Алгоритм_Луна)». Если номер представлен одним числом (только цифрами без разделителей групп) и невалиден, то тип токена меняется на `float`
  3 | otherInBrackets     | `String`   |                                                                          | Пунктуация в скобках              | `(?)`, `(!)`                                                                                                | Влияет на корректность распознавания окончаний предложений. В русском языке `(?)` ставится после слова для выражения сомнения или недоумения, `(!)` ставится после слова для выражения автора к чужому тексту (согласия, одобрения или иронии, возмущения)
  4 | dashBetweenWord     | `String`   |                                                                          | Дефис между словами               | `Сбербанк-Технологии`, `Григорьев-Апполонов`, `Санкт-Петербург`, `счёт-фактура`, `генерал-майор`, `красно-жёлтый`, `кто-нибудь` | Влияет на корректность извлечения слов с дефисами
  5 | bytes               | `String`   |                                                                          | Байты в разных представлениях     | `0xD182D0B5`, `0b101011`, `0o655`, `\xD1\x82\xD0\xB5`, `%D1%82%D0%B5`, `%u0442%u0435`, `\u{442}\u{435}`     | Влияет на корректность распознавания сущностей `float` и `word`.
  6 | xmlEntities         | `String`   |                                                                          | HTML сущности                     | `&gt;`, `&Ouml;`, `&#34;`, `&#x02DC;`, `&amp&amp;`                                                          | Влияет на корректность распознавания сущностей `float` и `word`.
  7 | xmlTags             | `String`   |                                                                          | HTML теги                         | `<!DOCTYPE html>`, `<IMG border=0 src="<fake> 'fake' &quot;"alt='<fake> "fake" &apos;' /><br/>`             | Влияет на корректность распознавания сущностей `float` и `word`.
  8 | word                | `String`   |                                                                          | Слово (последовательность букв с апострофами) | `Купи`, `слона`, `пожалуйста`                                                                   | Автоматически исправляются клавиатурные опечатки (буквы, набранные в неверной раскладке клавиатуры). Отделяются друг от друга «прилипшие» слова ([тест](https://regex101.com/r/FndOAq/13/)). Для слова проводится морфологический анализ, извлекается его лемма (базовая форма слова) и его грамматические признаки.
  9 | wordPlus            | `String`   |                                                                          | Слово, которое заканчиватся на `+` или `#`    | `C#`, `C++`, [`B+`](https://en.wikipedia.org/wiki/B%2B_tree), <nobr>`Европа+`,</nobr> <nobr>`Google+`</nobr> | Морфологический анализ отсутствует.
 10 | IPv4extend          | `String`   | <nobr>[IPv4](https://en.wikipedia.org/wiki/IPv4)</nobr>                  | Internet Protocol version 4       | <nobr>`192.168.1.1/24`,</nobr> <nobr>`192.168.1.33:3128`,</nobr> <nobr>`255.255.255.0`</nobr>               | Влияет на корректность распознавания сущности `float`. IPv4 можно указать вместе с портом или подсетью.
 11 | macAddress          | `String`   | <nobr>[MAC address](https://en.wikipedia.org/wiki/MAC_address)</nobr>    | Media access control address      | <nobr>`e0:69:95:78:13:53`</nobr>                                                                            | Влияет на корректность распознавания сущности `float`
 12 | date                | `String`   | <nobr>`"YYYY-MM-DD"`</nobr>                                              | Дата (число, месяц, год)          | <nobr>`31.01.2017`</nobr>, <nobr>`29/02/2000`,</nobr> <nobr>`2017-01-01`,</nobr> <nobr>`31 July 2017`,</nobr> <nobr>`31 января 2017`,</nobr> | Если год не указан, то подразумевается текущий год.
 13 | dob                 | `date`     |                                                                          | Дата рождения                     | `37 лет, родилась 29 апреля 1980`, `23 года (17 мая 1994)`                                                  | Слово "лет" или "родиться" (и их вариации), после которого должно следовать значение даты
 14 | time                | `String`   | <nobr>`"hh:mm:ss"`</nobr>                                                | Время (часы, минуты, секунды)     | `14:59`, <nobr>`02:30:59 PM`</nobr>                                                                         | Если секунды не указаны, то подразумевается `00`.
 15 | dateTime            | `String`   | <nobr>[ISO 8601](https://en.wikipedia.org/wiki/ISO_8601)</nobr>          | Дата и время                      | <nobr>`28 мая, 18:33` (локально)</nobr>, <nobr>`Wed, 14 Jun 2017 00:00:00 PDT` (UTC),</nobr> <nobr>`Mon, 18 Dec 1995 17:28:35 GMT` (GMT),</nobr> <nobr>`2011-10-05T14:48:00.000Z` (ISO 8601)</nobr> | После значения даты должно следовать значение времени 
 16 | currencyBeforeFloat | `String`   | <nobr>[ISO 4217 code](https://en.wikipedia.org/wiki/ISO_4217)</nobr>     | Валюта, расположенная до числа    | `€50`, `$ 17.5`                                                                                             |
 17 | currencyAfterFloat  | `String`   | <nobr>[ISO 4217 code](https://en.wikipedia.org/wiki/ISO_4217)</nobr>     | Валюта, расположенная после числа | `100$`, `35 EUR`, `35,000 руб.`                                                                             |
 18 | linkUrl             | `String`   | <nobr>[URL](https://en.wikipedia.org/wiki/URL)</nobr>                    | Ссылка на страницу или ресурс     | Начинается с протокола: <nobr>`http://site.com/path/to/?ключ=значение&key[1]=value1#привет`,</nobr> <nobr>`protocol://user:pass@site.com:8080/path/page?a=1&b=2#hash`,</nobr> <nobr>`https://МШП.рф/`,</nobr> <nobr>`http://xn--80aald4bq.xn--d1aqf.xn--p1ai/`;</nobr><br/> начинается с <nobr>`www.`:</nobr> <nobr>`www.ru`,</nobr> <nobr>`www.bfm.ru`;</nobr><br/> содержит `/` после домена: <nobr>`GitHub.com/username`</nobr>
 19 | email               | `String`   | <nobr>[Email](https://en.wikipedia.org/wiki/Email_address)</nobr>        | Адрес электронной почты           | <nobr>`MikeParker@OneDollar.Us`,</nobr> <nobr>`Иванов.Иван@Санкт-Петербург.онлайн`,</nobr> [ещё](https://regex101.com/r/Q4dsL5/12)
 20 | phone               | `String`   |                                                                          | Номер телефона                    | Международный формат: <nobr>`+7 926 1234567`,</nobr> <nobr>`+7 965 123 45 67`,</nobr> <nobr>`+7 968 123-45-67`,</nobr> <nobr>`+7(965)123-45-67`,</nobr> <nobr>`+7 (095) 361-999-1`,</nobr> <nobr>`+7 (83166) 1-23-45`,</nobr> <nobr>`+7 831 66 1-23-45`,</nobr> <nobr>`+1-800-MY-APPLE`</nobr>, <nobr>`+971 2 4567890`,</nobr> <nobr>`+971-50-123-45-67`,</nobr> <nobr>`+54 9 2982 123456`,</nobr> <nobr>`+373 68 007777`;</nobr> Локальный формат: <nobr>`8(965)1234567`,</nobr> <nobr>`8 (095) 361-999-1`,</nobr> <nobr>`8 8316 123 4 56`</nobr>
 21 | header              | `String`   |                                                                          | Markdown заголовок                | `# Заголовок`, `## Раздел`, `### Подраздел`                                                                 | Аналогия с HTML: `<h1>Заголовок</h1>`, ... `<h5>Подраздел</h5>`
 22 | listItem            | `String`   |                                                                          | Markdown элемент списка           | `* Элемент списка`                                                                                          | Аналогия с HTML: `<ul><li>Элемент списка</li></ul>`
 23 | link                | `String`   | <nobr>[URL](https://en.wikipedia.org/wiki/URL)</nobr>                    | Markdown ссылка                   | `[текст](url "заголовок")`                                                                                  | Извлекается текст, ссылка и заголовок. Аналогия с HTML: `<a href="url" title="заголовок">текст</a>`
 24 | image               | `String`   | <nobr>[URL](https://en.wikipedia.org/wiki/URL)</nobr>                    | Markdown изображение              | `![img.round#photo](url "заголовок")`                                                                       | Извлекается CSS селектор, ссылка и заголовок. Аналогия с HTML: `<img src="url" alt="заголовок" class="round" id="photo"/>`

#### Объекты

 №  | Тип сущности                    | Тип данных   | Название сущности                  | Примеры исходного текста для распознавания | Описание и особенности распознавания
---:|---------------------------------|--------------|------------------------------------|--------------------------------------------|-------------------------------------
 1  | **money**                       | `Object`     | **Денежный тип**                   | `$100`, `35 EUR`, `35,000 руб.`            | Значения суммы и валюты должны следовать друг за другом
 .  |   money.float                   |   `Number`   |   Число с плавающей запятой        |                                            | Значения суммы и валюты должны следовать друг за другом
 .  |   money.currency                |   `String`   |   Валюта                           |                                            | Значения суммы и валюты должны следовать друг за другом
 2  | **salary**                      | `money`      | **Зарплата**                       | `з.пл. 35,000 ₽`                           | Слово "зарплата" (и его вариации), после которого должно следовать значение денежного типа
 3  | **person**                      | `Object`     | **Персона (физическое лицо)**      | `Семенович Анна Григорьевна (1980-03-01)`  | 
 .  |   person.firstName              |   `String`   |   Имя                              |                                            | Свойство может отсутствовать, если данные отсутствуют в исходном тексте или их не удалось распознать
 .  |   person.lastName               |   `String`   |   Фамилия                          |                                            | Свойство может отсутствовать, если данные отсутствуют в исходном тексте или их не удалось распознать
 .  |   person.middleName             |   `String`   |   Отчество                         |                                            | Свойство может отсутствовать, если данные отсутствуют в исходном тексте или их не удалось распознать
 .  |   person.gender                 |   `String`   |   Пол                              |                                            | Пол определяется по ФИО, одно из значений: `"m"` (мужской), `"f"` (женский) или `""` (определить не удалось)
 .  |   person.dob                    |   `date`     |   Дата рождения                    |
 .  |   person.email                  |   `email`    |   Адрес электронной почты          |
 .  |   person.phone                  |   `phone`    |   Номер телефона                   |
 .  |   person.businessTripReadiness  |   `String`   |   Готовность к командировкам       |
 .  |   person.maritalStatus          |   `String`   |   Семейное положение               |
 .  |   person.childrenStatus         |   `String`   |   Наличие детей                    |
 .  |   person.drivingLicense         |   `String`   |   Наличие водительских прав        |
 .  |   person.educationLevel         |   `String`   |   Образование                      |
 .  |   person.relocationType         |   `String`   |   Готовность к переезду            |
 .  |   person.skillProfessional      |   `Array` of `String` | Профессиональные навыки   |
 .  |   person.languageLevel            |   `Array` of `Object` | Уровень владения языком |
 .  |   person.languageLevel[].language |   `String` | Язык                               |
 .  |   person.languageLevel[].level    |   `String` | Уровень владения                   |
 4  | **country**                     | `Object`     | **Страна**                         | `Россия`
 .  |   country.name                  |   `String`   |   Название страны                  |                
 5  | **region**                      | `Object`     | **Регион**                         | `Нижегородская область`                    | Регион для РФ — это республика, край, область или автономный округ.   
 .  |   region.name                   |   `String`   |   Название региона                 |
 .  |   region.country                |   `String`   |   Название страны                  |
 6  | **city**                        | `Object`     | **Город**                          | `Ростов-на-Дону`
 .  |   city.name                     |   `String`   |   Название города                  |
 .  |   city.region                   |   `String`   |   Название региона                 |
 .  |   city.country                  |   `String`   |   Название страны                  |
 7  | **metroStation**                | `Object`     | **Станция метро**                  | `Чкаловская`     
 .  |   metroStation.name             |   `String`   |   Название станции метро           |
 .  |   metroStation.city             |   `city`     |   Город                            |                          
 .  |   metroStation.lat              |   `Number`   |   Географическая широта            |
 .  |   metroStation.lng              |   `Number`   |   Географическая долгота           |
 .  |   metroStation.order            |   `Integer`  |   Порядковый номер станции на линии|
 .  |   metroStation.line             |   `Object`   |   Линия (ветка) метро              |
 .  |     metroStation.line.name      |     `String` |     Название линии                 |
 .  |     metroStation.line.hex_color |     `String` |     Цвет линии                     |
 8  | **metroLine**                   | `Object`     | **Линия метро**                    | `Первая`
 .  |   metroLine.name                |   `String`   |   Название линии                   |
 .  |   metroLine.city                |   `city`     |   Город                            |
 .  |   metroLine.hex_color           |   `String`   |   Цвет линии                       |

### Словари

Словари применяются для распознавания именованных сущностей и хранятся в отдельных файлах в папке `dict`.
При старте скрипта они загружаются в оперативную память компьютера в [хеш-таблицу](https://ru.wikipedia.org/wiki/Хеш-таблица).
Словари имеют первичный ключ (уникальный индекс), по которому можно проверить существование значения или получить дополнительную информацию в словаре.

Для поддержания порядка и корректной работы скрипта приняты следующие соглашения:
 
* Формат словарей: [JSON](http://www.json.org/) или [CSV](https://ru.wikipedia.org/wiki/CSV)
* Названия файлов должны состоять из латинских букв в нижнем регистре, цифр, знаков подчёркивания и точек. Расширение файлов: `.json` или `.csv`.  
* Слова в названии файлов словарей должны быть в единственном числе.
* Слова и фразы, которые находятся внутри словарей, должны быть в исходной/базовой форме. 
Как правило это [именительный падеж](http://rusgram.ru/Именительный_падеж) [едиственного числа](https://ru.wikipedia.org/wiki/Единственное_число).
* В CSV словарях значения из первой колонки по умолчанию используются в качестве первичного ключа словаря.

### Описание внутренних структур данных

Распарсенные данные хранятся в 2-х массивах:
* `tokensFlat` — элементами массива являются объекты токенов. 
  Массив `tokensFlat` необходим для получения исходного фрагмента текста по заданной начальной и конечной позиции токенов.
* `tokensTree` — элементами массива являются массивы или объекты токенов. 
  Массив `tokensTree` необходим для глубокой структуризации документа на параграфы и предложения, выделения ссылок и обнаружения именованных сущностей.

В массиве `tokensTree` токен представляет собой объект со следующими свойствами:

Свойство             | Тип                          | Обязательный?              | Описание
---------------------|------------------------------|----------------------------|---------------------------------------------------------
type                 | `String`                     | да                         | Тип токена
value                | `Number`, `String`, `Object` | да                         | Значение токена
  value.\<nameN\>    | `String`                     | да                         | Объект должен иметь одно или несколько свойств, их состав зависит от типа токена. Значениями свойств должны быть строки. Для примера см. описание токена `person` 
tokensFlatRange      | `Array` of `Integer`         | да                         | Позиция токена в массиве `tokensFlat`  
  tokensFlatRange[0] | `Integer`                    | да                         | Начало позиции
  tokensFlatRange[1] | `Integer`                    | да                         | Окончание позиции
lang                 | `String`                     | да, если тип токена `word` | Язык слова, возможные значения: `ru`, `en` 
textTransform        | `String`                     | да, если тип токена `word` | Трансформация слова, возможные значения: `capitalize`, `lowercase`, `uppercase`
grams                | `Array` of `Object`          | да, если тип токена `word` | Массив объектов с грамматической информацией           
  grams[].lemma      | `String`                     | да, если тип токена `word` | Базовая форма слова
  grams[].weight     | `Number`                     | да, если тип токена `word` | Вес грамматической формы, число от `0` до `1`
  grams[].attrs      | `Array` of `String`          | да, если тип токена `word` | Массив строк с [грамматическими признаками](https://tech.yandex.ru/mystem/doc/grammemes-values-docpage/), например `["S", "муж", "неод", "род,мн"]`
linkText             | `Array` of `Object`          | да, если тип токена `link` | Массив объектов токенов для текста ссылки 
linkTitle            | `Array` of `Object`          | да, если тип токена `link` | Массив объектов токенов для заголовка ссылки
imageTitle           | `Array` of `Object`          | да, если тип токена `image`| Массив объектов токенов для заголовка изображения
imageSelector        | `String`                     | да, если тип токена `image`| CSS селектор изображения

# Файл конфигурации

Файл `config.*.js` представляет из себя NodeJS модуль, который экспортирует JavaScript объект следующей структуры:

Свойство                            | Тип                                     | Обязательный?| Описание
------------------------------------|-----------------------------------------|--------------|---------------------------------------------------------
**\<host\>**                        | `Object`                                | да           | **Секция с настройками для хоста `<host>`**. Рекомендуется указываеть в нижнем регистре. Порт указывается опционально через двоеточие, примеры: `site.com`, `site.com:8080`. Для скрипта `import.sh` имя хоста берётся из URL, который передаётся скрипту в параметре `--url`. Для скрипта `extract.sh` имя хоста берётся из URL ссылки `source`, которая находится внизу `*.md` файла.
  \<host\>.hostAliases              | `RegExp`, `String`, `Array` of `String` | нет          |   Псевдонимы хостов. Например, «зеркала» или региональные поддомены.
  \<host\>.resourceHostAllow        | `RegExp`, `String`, `Array` of `String` | нет          |   «Белый» список хостов, с которых разрешено загружать ресурсы веб-страницы (`*.js`, `*.css`, `…`). Если не указано, то разрешена загрузка со любых хостов.
  \<host\>.resourceHostDisallow     | `RegExp`, `String`, `Array` of `String` | нет          |   «Чёрный» список хостов, с которых запрещено загружать ресурсы веб-страницы (`*.js`, `*.css`, `…`). Сначала проверяется «чёрный» список, потом «белый».
**\<host\>.lists**                  | `Object`                                | да           | **Секция с настройками для обработки страниц со ссылками на документы**
  \<host\>.lists.urlMatch           |   `RegExp`                              | да           |   Регулярное выражение для захвата ссылок на списки документов (постраничная навигация). Псевдонимы хостов должны быть учтены. Если на сайте применяется AJAX (HTTP заголовок `X-Requested-With: XMLHttpRequest`) динамическая подгрузка списка ссылок (например, при клике на кнопку/ссылку «далее» или при прокрутке страницы вниз), то URL формируется из `location.href` по правилам, указанным в параметре `urlReplacements`.
  \<host\>.lists.ready              |   `Function`                            | нет          |   См. `<host>.document.ready`
  \<host\>.lists.wait               |   `Function`                            | нет          |   См. `<host>.document.wait`
  \<host\>.lists.urlReplacements    |   `Array` of `Array`                    | нет          |   См. `<host>.document.urlReplacements`    
**\<host\>.document**               | `Object`                                | да           | **Секция с настройками обработки страниц документов**
  \<host\>.document.urlMatch        |   `RegExp`                              | да           |   Регулярное выражение для захвата ссылок на документы. Псевдонимы хостов должны быть учтены.
  \<host\>.document.idBackref       |   `Integer`                             | нет          |   Номер группы из рег. выражения в `urlMatch`, в котором захватывается идентификатор документа. Для декодирования части URL будет вызван [`decodeURIComponent()`](https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/decodeURIComponent)
  \<host\>.document.ready           |   `Function`                            | нет          |   Функция, которая будет выполнена в браузере после построения DOM. Должна возвратить `boolean`. Функции `ready` и `wait` работают в паре!!!
  \<host\>.document.wait            |   `Function`                            | нет          |   Если функция `ready` вернёт true, то функция `wait` будет периодически вызываться в браузере до тех пор, пока не возвратит `true`, или пока время ожидания (равно времени ожидания загрузки ресурсов) не истечёт. Затем скрипт сохранит содержимое страницы в файлы `*.dom.html` и `*.md` и завершит работу. Если функция `ready` вернёт `false`, сохранение в файл будет сделано сразу без вызова `wait`.
  \<host\>.document.urlReplacements |   `Array` of `Array`                    | нет          |   Массив для трансформации URL (добавление/удаление/замена путей и GET параметров). Каждый элемент массива является массивом с указанием пар замен (строка или рег. выражение для поиска, строка для замены). Подробнее см. на http://xregexp.com/api/#replaceEach
  \<host\>.document.cssSelector     |   `String`                              | нет          |   CSS селектор, который используется для выбора нужного элемента при конвертации из DOM HTML в Markdown. Подробнее см. на http://api.jquery.com/category/Selectors/ 
**\<host\>.auth**                   | `Object`                                | нет          | **Секция с настройками авторизации пользователя на сайте**
  \<host\>.auth.url                 |   `String`                              | да           |   Адрес страницы, на которой гарантированно должна быть форма авторизации с полями ввода имени пользователя и пароля 
  \<host\>.auth.username            |   `String`                              | да           |   Имя пользователя для заполнения формы аторизации. Значение можно передать через ключ командной строки `--username`
  \<host\>.auth.password            |   `String`                              | да           |   Пароль для заполнения формы аторизации. Значение можно передать через ключ командной строки `--password`
  \<host\>.auth.delay               |   `Number`                              | нет          |   Ожидание в секундах перед отправкой данных формы ввода на сервер
