# Назначение

ПО состоит из 2-х скриптов:

1. Загрузка URL и конвертации веб-страницы в файлы формата DOM HTML и [Markdown](https://guides.github.com/features/mastering-markdown/).
2. Распознавание и извлечение именованных сущностей из неструктурированного текста (из файла Markdown).

Скрипты используются для загрузки (импортирования) резюме и вакансий из разных сайтов, их обработки и добавления на сайт `https://rabota.ru`.

# Требования к рабочему окружению

* ОС, совместимая с `Linux Ubuntu x64 v16.x` или более поздняя
* `1 GB` оперативной памяти
* `32 Mb` свободного места на диске
* `NodeJS v8.9.0` или более поздняя ([инструкция по установке](https://nodejs.org/en/download/package-manager/#debian-and-ubuntu-based-linux-distributions))

# Установка

```bash
$ git clone git@git.rabota.space:rinat/rabota-importer.git
$ cd rabota-importer
$ ./install.sh
```

# Использование скриптов

## Выгрузка веб-страницы в файл

**Формат вызова:**

`$ ./import.sh <опции…> [2> <errorFile>]`
    
В квадратных скобках указана необязательная часть.

**Показать все опции:**

`$ ./import.sh` или `$ cat import.txt`

**Пример вызова:**

`$ ./import.sh --config-file=config.resume.js --url="https://ya.ru" --output-file-prefix=ya`

**Особенности загрузки**

* Скрипт может загружать веб-страницы с поддержкой `JavaScript`, `AJAX`, `Cookie`, сеансов, перенаправлений и авторизации (вход по логину и паролю).  
* Из ресурсов веб-страницы изображения и шрифты по ссылкам (кроме [`data:URI`](https://en.wikipedia.org/wiki/Data_URI_scheme)) не загружаются (нет необходимости). 
За счёт этого экономится трафик и увеличивается скорость работы.
* Скрипт имеет защиту от зацикливания или слишком долгой работы (см. содержимое файла `import.sh`)

**На выходе записываются файлы:**

1. `./log/<output-file-pefix>.dom.html` — файл с DOM HTML, который сформировал браузер после загрузки страницы и выполнения javascript скриптов.
Можно настраивать элемент DOM для выгрузки в HTML через указание CSS селектора в конфигурационном файле, по умолчанию это `body`.
В блоке `<head>` в теге `<meta name="source" …>` хранится ссылка на источник выгрузки, дата и время выгрузки. HTML отфильтован и записывается: 
    * без скриптов (`<script>`)
    * без стилей (`<style>`)
    * без комментариев (`<!-- … -->`)
    * без скрытых/невидимых элементов (`display:none; visibility:hidden; opacity:0` и отступы элементов за пределы видимости экрана монитора)
    * без атрибутов с обработчиками событий (`on*`)
    * без атрибутов `style`
2. `./log/<output-file-pefix>.md` — файл в формате [Markdown](https://guides.github.com/features/mastering-markdown/).
При конвертации из DOM HTML в Markdown содержимое тегов `<iframe>` игнорируется.
Внизу файла дописывается ссылка на источник выгрузки, дата и время выгрузки. 
Текущая реализация конвертации из HTML в Markdown неполная, но поддерживает обработку основных HTML элементов: 
    * параграфы (`<p>`)
    * переносы строк (`<br>`) 
    * заголовки (`<h[123456]>`)
    * списки (`<li>`) 
    * ссылки (`<a href="…">`)
    * изображения (`<img>`)
3. `./log/<config-type>~[<username>]@cookies-persistent.txt` — файл для хранения постоянных кук. 
Тип конфига `<config-type>` берётся из значения параметра `--config-file`, формат: `config.<config-type>.js`.
Имя пользователя `<username>` будет записано, если оно было передано через опцию `--username` командной строки.
4. `./log/<config-type>~[<username>]@<hostname>.cookies.json` — файл для хранения сессионных кук. 

В случае возникновения ошибки файлы записаны не будут, а скрипт вернёт код возврата `1`. 

**Потоки:**

1. В `STDOUT` пишутся:
    * `белым цветом`: сообщения PhantomJS о ходе работы скрипта (начало операции/шага, сводная информация, статистика)
    * `зелёным цветом`: сообщения об успешных операциях/шагах
    * `синим цветом`: 
        * сообщения о перенаправлениях на другой URL
        * данные POST запроса 
        * сообщения скриптов веб-страницы, выведенные в консоль браузера (методы `console.*()`)
    * `оранжевым цветом`: сообщения с предупреждениями — допустимые логикой скрипта ошибки (скрипт не прерывает работу)
2. В `STDERR` пишутся (`красным цветом`):
    * сообщения об ошибках выполнения PhantomJS (скрипт прерывает работу)
    * сообщения об ошибках выполнения скриптов веб-страницы (скрипт не прерывает работу) 

### Сценарий авторизации (шаги)

1. Загружаем страницу `startUrl` (его передали скрипту через параметр `--url`)
2. Проверяем, авторизован ли пользователь на странице `startUrl` (по наличию формы авторизации или «магических» меток)
3. Если пользователь авторизован, сохраняем результат загрузки страницы `startUrl` и завершаем работу (успех)
4. Если не удалось определить, авторизован ли пользователь, то завершаем работу с ошибкой
5. Если на странице `startUrl` формы авторизации нет, загружаем страницу `authUrl`
6. Если на странице `authUrl` формы авторизации нет, завершаем работу с ошибкой авторизации
7. Заполняем форму авторизации (вводим имя пользователя и пароль, отмечаем флаг «запомнить», если он есть) и отправляем данные на сервер на `authPostUrl` (`<form action="authPostUrl">`)
8. Загружаем страницу `authPostUrl`
9. Проверяем, авторизован ли пользователь на странице `authPostUrl` (по наличию формы авторизации или «магических» меток)
10. Если не удалось определить, авторизован ли пользователь, то завершаем работу с ошибкой
11. Если пользователь авторизован, переходим к пункту `1`.
12. Завершаем работу с ошибкой авторизации (неверное имя пользователя и/или пароль?)

## Обработка файла (распознавание и извлечение информации)

**Формат вызова:**

`$ ./extract.sh <опции…> [2> <errorFile>]`

В квадратных скобках указана необязательная часть.

**Показать все опции:**

`$ ./extract.sh` или `$ cat extract.txt`

**Потоки:**

* В `STDOUT` пишется результат работы (JSON)
* В `STDERR` пишутся сообщения об ошибках

# Структура папок проекта

Папка               | Описание
--------------------|---------------------------------------------------------------------------------------------------
`dev`               | Набор разнородных файлов для разработки, для продуктивного режима не используются
`dict`              | Словари, используемые для распознавания именованных сущностей
`lib`               | Библиотеки программного кода
`log`               | Папка для выгрузки обработанных файлов, место хранения кук (должен быть доступ на запись в папку)
`node_modules`      | Модули для `NodeJS`
`phantomjs_modules` | Модули для `PhantomJS` 
`test`              | Набор тестовых экземпляров для тестирования распознавания сущностей
`tmp`               | Папка для кеша `PhantomJS` и временных файлов (должен быть доступ на запись в папку)
`vendor`            | Сторонние библиотеки, которые используются в проекте
`vendor/bin`        | Сторонние исполняемые файлы, которые используются в проекте

# Файл конфигурации

Файл `config.*.js` представляет из себя NodeJS модуль, который экспортирует объект следующей структуры:

Параметр                          | Тип        | Обязательный?| Описание
----------------------------------|------------|--------------|---------------------------------------------------------
**`<host>`**                      | `Object`   | **да**       | **Секция с настройками для хоста `<host>`**. Рекомендуется указываеть в нижнем регистре. Порт указывается опционально через двоеточие, примеры: `site.com`, `site.com:8080`. Для скрипта `import.sh` имя хоста берётся из URL, который передаётся скрипту в параметре `--url`. Для скрипта `extract.sh` имя хоста берётся из URL ссылки `source`, которая находится внизу `*.md` файла.
`<host>.hostAliases`              | `RegExp`   | нет          |    Регулярное выражение для указания псевдонимов хостов. Например, «зеркала» или региональные поддомены. 
`<host>.resourceHostAllow`        | `RegExp`   | нет          |    Регулярное выражение с «белым» списком хостов, с которых разрешено загружать ресурсы веб-страницы (`*.js`, `*.css`, `…`). Если не указано, то разрешена загрузка только для хоста из URL, переданного в параметре `--url`.
`<host>.resourceUrlDisallow`      | `RegExp`   | нет          |    Регулярное выражение с «чёрным» списком URL, с которых запрещено загружать ресурсы веб-страницы (`*.js`, `*.css`, `…`). Сначала проверяется «чёрный» список, потом «белый».
**`<host>.lists`**                | `Object`   | **да**       | **Секция с настройками для обработки страниц со ссылками на документы**
`<host>.lists.urlMatch`           | `RegExp`   | нет          |    Регулярное выражение для захвата ссылок на списки документов (постраничная навигация). Псевдонимы хостов должны быть учтены. Если на сайте применяется AJAX (HTTP заголовок `X-Requested-With: XMLHttpRequest`) динамическая подгрузка списка ссылок (например, при клике на кнопку/ссылку «далее» или при прокрутке страницы вниз), то URL формируется из `location.href` по правилам, указанным в параметре `urlReplacements`.
`<host>.lists.ready`              | `Function` | нет          |    См. `<host>.document.ready`
`<host>.lists.wait`               | `Function` | нет          |    См. `<host>.document.wait`
`<host>.lists.urlReplacements`    | `Array`    | нет          |    См. `<host>.document.urlReplacements`    
**`<host>.document`**             | `Object`   | **да**       | **Секция с настройками обработки страниц документов**
`<host>.document.urlMatch`        | `RegExp`   | **да**       |    Регулярное выражение для захвата ссылок на документы. Псевдонимы хостов должны быть учтены.
`<host>.document.idBackref`       | `Integer`  | нет          |    Номер группы из рег. выражения в `urlMatch`, в котором захватывается идентификатор документа. Для декодирования части URL будет вызван [`decodeURIComponent()`](https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/decodeURIComponent)
`<host>.document.ready`           | `Function` | нет          |    Функция, которая будет выполнена после построения DOM. Должна возвратить `boolean`. Функции `ready` и `wait` работают в паре!!!
`<host>.document.wait`            | `Function` | нет          |    Если функция `ready` вернёт true, то функция `wait` будет периодически вызываться до тех пор, пока не возвратит `true`, или пока время ожидания не истечёт. Затем скрипт сохранит содержимое страницы в файлы `*.dom.html` и `*.md` и завершит работу. Если функция `ready` вернёт `false`, сохранение в файл будет сделано сразу без вызова `wait`.
`<host>.document.urlReplacements` | `Array`    | нет          |    Массив для трансформации URL (добавление/удаление/замена путей и GET параметров). Каждый элемент массива является массивом с указанием пар замен (строка или рег. выражение для поиска, строка для замены). Подробнее см. на http://xregexp.com/api/#replaceEach
`<host>.document.cssSelector`     | `String`   | нет          |    CSS селектор, который используется для выбора нужного элемента при конвертации из DOM HTML в Markdown. Подробнее см. на http://api.jquery.com/category/Selectors/ 
**`<host>.auth`**                 | `Object`   | нет          | **Секция с настройками авторизации пользователя на сайте**
`<host>.auth.url`                 | `String`   | нет          |    Адрес страницы, на которой гарантированно должна быть форма авторизации с полями ввода имени пользователя и пароля 
`<host>.auth.username`            | `String`   | нет          |    Имя пользователя для заполнения формы аторизации. Значение можно передать через ключ командной строки `--username`
`<host>.auth.password`            | `String`   | нет          |    Пароль для заполнения формы аторизации. Значение можно передать через ключ командной строки `--password`
